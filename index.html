<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Wertykalny Platformer - Urodziny</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        html, body {
            width: 100%;
            height: 100%;
            position: fixed; 
            top: 0;
            left: 0;
            background-color: #111;
            overflow: hidden; 
            touch-action: none; 
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: 'Press Start 2P', cursive;
        }
        canvas {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain; 
            background-color: #000;
        }
    </style>
</head>
<body>

<canvas id="gameCanvas"></canvas>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');

    const GAME_WIDTH = 390;
    const GAME_HEIGHT = 844;
    canvas.width = GAME_WIDTH;
    canvas.height = GAME_HEIGHT;

    const bgImage = new Image(); bgImage.src = 'background.png';
    const platformLower = new Image(); platformLower.src = 'platform_lower.png';
    const platformDirt = new Image(); platformDirt.src = 'platform_dirt.png';
    const platformUpper = new Image(); platformUpper.src = 'platform_upper.png';
    const platformWin = new Image(); platformWin.src = 'platform_win.png';
    const charImage = new Image(); charImage.src = 'character.png';
    
    const presentImage = new Image(); presentImage.src = 'present.png';
    const braceletImage = new Image(); braceletImage.src = 'bransoletka.png';
    const teslaImage = new Image(); teslaImage.src = 'tesla.png';
    const domImage = new Image(); domImage.src = 'dom.png';

    let totalScroll = 0;
    let score = 0;
    const GOAL_SCORE = 100;

    let gameState = 'start'; 
    
    let winTime = 0;
    let winPhase = 0; 
    let clickedPresentIndex = -1;
    let shakeStartTime = 0;
    let revealTime = 0;     
    let finalPhaseStartTime = 0; 

    const player = {
        x: GAME_WIDTH / 2 - 30,
        y: GAME_HEIGHT - 200,
        width: 60,  
        height: 40,
        vx: 0,
        vy: 0,
        speed: 6,
        jumpStrength: -16, 
        gravity: 0.6
    };

    let platforms = [];
    const basePlatformWidth = 90;  
    const basePlatformHeight = 60;
    let hasSpawnedWinPlatform = false;

    let isMovingLeft = false;
    let isMovingRight = false;

    let particles = [];
    let heartParticles = []; 
    const fireworkColors = ['#ff0000', '#00ff00', '#0000ff', '#ffff00', '#ff00ff', '#00ffff', '#ffffff'];

    function initPlatforms() {
        platforms = [];
        hasSpawnedWinPlatform = false;
        platforms.push({ 
            x: GAME_WIDTH / 2 - basePlatformWidth / 2, 
            y: GAME_HEIGHT - 50, 
            width: basePlatformWidth,
            height: basePlatformHeight,
            absoluteY: 0, 
            isWinPlatform: false 
        });

        for (let i = 1; i < 15; i++) {
            spawnPlatform(GAME_HEIGHT - 50 - (i * 100)); 
        }
    }

    function spawnPlatform(yPos) {
        if (hasSpawnedWinPlatform) return;

        const absoluteY = totalScroll + (GAME_HEIGHT - yPos); 
        const isWin = absoluteY >= GOAL_SCORE * 100;
        
        const pWidth = isWin ? basePlatformWidth * 1.3 : basePlatformWidth;
        const pHeight = isWin ? basePlatformHeight * 1.3 : basePlatformHeight;

        if (isWin) {
            platforms.push({ 
                x: GAME_WIDTH / 2 - pWidth / 2, 
                y: yPos, 
                width: pWidth,
                height: pHeight,
                absoluteY: absoluteY, 
                isWinPlatform: true 
            });
            hasSpawnedWinPlatform = true;
        } else {
            const xPos = Math.random() * (GAME_WIDTH - pWidth);
            platforms.push({ 
                x: xPos, y: yPos, 
                width: pWidth, height: pHeight,
                absoluteY: absoluteY, 
                isWinPlatform: false 
            });
        }
    }

    function createFirework() {
        const x = Math.random() * GAME_WIDTH;
        const y = Math.random() * (GAME_HEIGHT / 2); 
        const color = fireworkColors[Math.floor(Math.random() * fireworkColors.length)];
        const numParticles = 30 + Math.random() * 20;

        for (let i = 0; i < numParticles; i++) {
            const angle = Math.random() * Math.PI * 2;
            const speed = Math.random() * 5 + 1;
            particles.push({
                x: x, y: y,
                vx: Math.cos(angle) * speed, vy: Math.sin(angle) * speed,
                color: color, life: 1.0, decay: Math.random() * 0.02 + 0.01
            });
        }
    }

    function createHeart() {
        const x = Math.random() * GAME_WIDTH;
        const y = GAME_HEIGHT + 20; 
        const speed = Math.random() * 2 + 1;
        const size = Math.random() * 10 + 5;
        heartParticles.push({
            x: x, y: y,
            vy: -speed, 
            size: size,
            color: '#ff69b4' 
        });
    }

    function updateParticles() {
        for (let i = particles.length - 1; i >= 0; i--) {
            let p = particles[i];
            p.x += p.vx; p.y += p.vy; p.vy += 0.05; 
            p.life -= p.decay;
            if (p.life <= 0) particles.splice(i, 1);
        }
        if (winPhase === 5) {
             if (Math.random() < 0.05) createHeart(); 
             for (let i = heartParticles.length - 1; i >= 0; i--) {
                let h = heartParticles[i];
                h.y += h.vy;
                if (h.y + h.size < 0) heartParticles.splice(i, 1); 
            }
        }
    }
    
    function drawPixelHeart(ctx, x, y, size, color) {
        ctx.fillStyle = color;
        const s = size / 5; 
        ctx.fillRect(x + s, y, s, s);
        ctx.fillRect(x + 3*s, y, s, s);
        ctx.fillRect(x, y + s, s, s);
        ctx.fillRect(x + 2*s, y + s, s, s);
        ctx.fillRect(x + 4*s, y + s, s, s);
        ctx.fillRect(x + s, y + 2*s, s, s);
        ctx.fillRect(x + 3*s, y + 2*s, s, s);
        ctx.fillRect(x + 2*s, y + 3*s, s, s);
    }

    function requestFullScreen() {
        const elem = document.documentElement;
        try {
            if (elem.requestFullscreen) {
                elem.requestFullscreen().catch(err => {});
            } else if (elem.webkitRequestFullscreen) {
                elem.webkitRequestFullscreen();
            } else if (elem.msRequestFullscreen) {
                elem.msRequestFullscreen();
            }
        } catch(e) {}
    }

    function handleInputStart(clientX, clientY) {
        const rect = canvas.getBoundingClientRect();
        const scaleX = canvas.width / rect.width;
        const scaleY = canvas.height / rect.height;
        
        const clickX = (clientX - rect.left) * scaleX;
        const clickY = (clientY - rect.top) * scaleY;

        if (gameState === 'start') {
            const btnW = 260, btnH = 60;
            const btnX = GAME_WIDTH / 2 - btnW / 2;
            const btnY = GAME_HEIGHT / 2 + 100;

            if (clickX >= btnX && clickX <= btnX + btnW && clickY >= btnY && clickY <= btnY + btnH) {
                requestFullScreen(); 
                gameState = 'playing';
                player.vy = player.jumpStrength; 
            }
            return; 
        }

        if (gameState === 'win') {
            const now = Date.now();
            
            if (winPhase === 1) {
                const pSize = 80;
                const pY = GAME_HEIGHT / 2 - pSize / 2;
                const centersX = [GAME_WIDTH/2 - 110, GAME_WIDTH/2, GAME_WIDTH/2 + 110];
                for (let i = 0; i < 3; i++) {
                    const pX = centersX[i] - pSize / 2;
                    if (clickX >= pX && clickX <= pX + pSize && clickY >= pY && clickY <= pY + pSize) {
                        winPhase = 2; 
                        clickedPresentIndex = i;
                        shakeStartTime = now;
                        break;
                    }
                }
            }
            
            if (winPhase === 3 && now - revealTime >= 3000) {
                const btnWidth = 300; const btnHeight = 60;
                const btnX = GAME_WIDTH / 2 - btnWidth / 2; const btnY = GAME_HEIGHT - 120;
                if (clickX >= btnX && clickX <= btnX + btnWidth && clickY >= btnY && clickY <= btnY + btnHeight) {
                    winPhase = 4; 
                    finalPhaseStartTime = now; 
                }
            }

            if (winPhase === 4 && now - finalPhaseStartTime >= 3000) {
                 const btnWidth = 340; const btnHeight = 70;
                 const btnX = GAME_WIDTH / 2 - btnWidth / 2; const btnY = GAME_HEIGHT - 120;
                 if (clickX >= btnX && clickX <= btnX + btnWidth && clickY >= btnY && clickY <= btnY + btnHeight) {
                    winPhase = 5; 
                }
            }
            return; 
        }

        if (clickX < GAME_WIDTH / 2) {
            isMovingLeft = true; isMovingRight = false;
        } else {
            isMovingRight = true; isMovingLeft = false;
        }
    }

    function handleInputEnd() {
        isMovingLeft = false; isMovingRight = false;
    }

    window.addEventListener('touchstart', (e) => handleInputStart(e.touches[0].clientX, e.touches[0].clientY));
    window.addEventListener('touchend', handleInputEnd);
    window.addEventListener('mousedown', (e) => handleInputStart(e.clientX, e.clientY));
    window.addEventListener('mouseup', handleInputEnd);

    function update() {
        if (gameState === 'start') return;

        const now = Date.now();

        if (gameState === 'win') {
            if (winPhase < 5 && Math.random() < 0.1) createFirework();
            updateParticles();

            if (winPhase === 0 && now - winTime >= 3000) {
                winPhase = 1; 
            } else if (winPhase === 2 && now - shakeStartTime >= 1500) {
                winPhase = 3; 
                revealTime = now; 
            }
            return; 
        }

        if (isMovingLeft) player.x -= player.speed;
        if (isMovingRight) player.x += player.speed;

        if (player.x + player.width < 0) player.x = GAME_WIDTH;
        if (player.x > GAME_WIDTH) player.x = -player.width;

        player.vy += player.gravity;
        player.y += player.vy;

        if (player.y < GAME_HEIGHT / 2) {
            const offset = GAME_HEIGHT / 2 - player.y;
            player.y += offset; 
            platforms.forEach(p => p.y += offset);
            totalScroll += offset; 
            
            let currentScore = Math.floor(totalScroll / 100);
            if (currentScore > score) score = currentScore;
        }

        if (player.vy > 0) {
            platforms.forEach(p => {
                if (player.x < p.x + p.width &&
                    player.x + player.width > p.x &&
                    player.y + player.height > p.y &&
                    player.y + player.height < p.y + player.vy + 10) { 
                        
                        if (p.isWinPlatform) {
                            gameState = 'win';
                            winTime = now;
                            winPhase = 0;
                            player.vy = 0;
                            player.y = p.y - player.height;
                            player.x = p.x + (p.width / 2) - (player.width / 2);
                            isMovingLeft = false; isMovingRight = false;
                        } else {
                            player.vy = player.jumpStrength;
                        }
                }
            });
        }

        platforms = platforms.filter(p => p.y < GAME_HEIGHT + 50);
        
        if (!hasSpawnedWinPlatform) {
            while (platforms.length < 15) {
                const highestPlatformY = Math.min(...platforms.map(p => p.y));
                spawnPlatform(highestPlatformY - 100); 
            }
        }

        if (player.y > GAME_HEIGHT) {
            player.y = GAME_HEIGHT - 200;
            player.x = GAME_WIDTH / 2 - player.width / 2;
            player.vy = 0;
            totalScroll = 0; score = 0; particles = []; heartParticles = [];
            gameState = 'playing';
            initPlatforms();
            player.vy = player.jumpStrength; 
        }
    }

    function draw() {
        ctx.clearRect(0, 0, GAME_WIDTH, GAME_HEIGHT);

        if (bgImage.complete && bgImage.naturalWidth !== 0) {
            if (winPhase === 5) {
                const scale = Math.max(GAME_WIDTH / bgImage.naturalWidth, GAME_HEIGHT / bgImage.naturalHeight);
                const scaledW = bgImage.naturalWidth * scale;
                const scaledH = bgImage.naturalHeight * scale;
                const x = (GAME_WIDTH - scaledW) / 2;
                const y = (GAME_HEIGHT - scaledH) / 2;
                ctx.drawImage(bgImage, x, y, scaledW, scaledH);
            } else {
                const bgScale = 1.2; 
                const bgScaledWidth = 1536 * bgScale; 
                const bgScaledHeight = 1024 * bgScale; 
                let progress = Math.min(score / GOAL_SCORE, 1);
                const maxBgScroll = bgScaledHeight - GAME_HEIGHT;
                let bgY = -maxBgScroll + (progress * maxBgScroll);
                let bgX = -(bgScaledWidth - GAME_WIDTH) / 2;
                ctx.drawImage(bgImage, bgX, bgY, bgScaledWidth, bgScaledHeight);
            }
        } else {
            ctx.fillStyle = '#222';
            ctx.fillRect(0, 0, GAME_WIDTH, GAME_HEIGHT);
        }

        if (winPhase === 5) {
             heartParticles.forEach(h => {
                drawPixelHeart(ctx, h.x, h.y, h.size, h.color);
            });
            return;
        }

        ctx.shadowColor = "rgba(0, 0, 0, 0.6)";
        ctx.shadowBlur = 15;
        ctx.shadowOffsetX = 8;
        ctx.shadowOffsetY = 8;

        platforms.forEach(p => {
            let currentImg = platformLower; 
            let pScore = Math.floor(p.absoluteY / 100);
            if (p.isWinPlatform) currentImg = platformWin;
            else if (pScore >= 66) currentImg = platformUpper;
            else if (pScore >= 33) currentImg = platformDirt;

            if (currentImg.complete && currentImg.naturalWidth !== 0) {
                ctx.drawImage(currentImg, p.x, p.y, p.width, p.height);
            } else {
                ctx.fillStyle = p.isWinPlatform ? 'gold' : '#555';
                ctx.fillRect(p.x, p.y, p.width, p.height);
            }
        });

        if (charImage.complete && charImage.naturalWidth !== 0) {
            ctx.drawImage(charImage, player.x, player.y, player.width, player.height);
        } else {
            ctx.fillStyle = 'red';
            ctx.fillRect(player.x, player.y, player.width, player.height);
        }

        ctx.shadowColor = "transparent";
        ctx.shadowBlur = 0;
        ctx.shadowOffsetX = 0;
        ctx.shadowOffsetY = 0;

        if (gameState === 'playing') {
            ctx.fillStyle = 'white';
            ctx.font = '36px "Press Start 2P"';
            ctx.textAlign = 'center';
            ctx.shadowColor = "black";
            ctx.shadowOffsetX = 3; ctx.shadowOffsetY = 3;
            ctx.fillText(`${score}`, GAME_WIDTH / 2, 70);
            ctx.shadowColor = "transparent";
        }

        if (gameState === 'start') {
            ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
            ctx.fillRect(0, 0, GAME_WIDTH, GAME_HEIGHT);

            ctx.fillStyle = 'white';
            ctx.textAlign = 'center';
            ctx.shadowColor = "black";
            ctx.shadowOffsetX = 2; ctx.shadowOffsetY = 2;
            
            ctx.font = '30px "Press Start 2P"';
            ctx.fillText("JAK GRAC?", GAME_WIDTH / 2, GAME_HEIGHT / 2 - 120);

            ctx.font = '12px "Press Start 2P"';
            ctx.fillStyle = '#87CEEB'; 
            ctx.fillText("Dotknij LEWEJ polowy", GAME_WIDTH / 2, GAME_HEIGHT / 2 - 40);
            ctx.fillStyle = 'white';
            ctx.fillText("aby isc w LEWO", GAME_WIDTH / 2, GAME_HEIGHT / 2 - 15);

            ctx.fillStyle = '#ffb6c1'; 
            ctx.fillText("Dotknij PRAWEJ polowy", GAME_WIDTH / 2, GAME_HEIGHT / 2 + 35);
            ctx.fillStyle = 'white';
            ctx.fillText("aby isc w PRAWO", GAME_WIDTH / 2, GAME_HEIGHT / 2 + 60);

            ctx.shadowColor = "transparent";

            const btnW = 260, btnH = 60;
            const btnX = GAME_WIDTH / 2 - btnW / 2;
            const btnY = GAME_HEIGHT / 2 + 100;

            ctx.fillStyle = '#4CAF50'; 
            ctx.fillRect(btnX, btnY, btnW, btnH);
            ctx.strokeStyle = '#FFFFFF'; 
            ctx.lineWidth = 4; 
            ctx.strokeRect(btnX, btnY, btnW, btnH);

            ctx.fillStyle = 'white';
            ctx.font = '16px "Press Start 2P"';
            ctx.fillText("START", GAME_WIDTH / 2, btnY + 38);

            ctx.font = '8px "Press Start 2P"';
            ctx.fillText("Safari: Dodaj do ekranu poczatkowego", GAME_WIDTH / 2, btnY + 85);
            ctx.fillText("aby grac na 100% pelnym ekranie!", GAME_WIDTH / 2, btnY + 100);
        }

        if (gameState === 'win') {
            particles.forEach(p => {
                ctx.globalAlpha = Math.max(0, p.life);
                ctx.fillStyle = p.color;
                ctx.fillRect(p.x, p.y, 6, 6);
            });
            ctx.globalAlpha = 1.0;

            ctx.fillStyle = '#FFD700'; 
            ctx.textAlign = 'center';
            ctx.shadowColor = "black";
            ctx.shadowOffsetX = 4; ctx.shadowOffsetY = 4;
            
            if (winPhase === 0) {
                ctx.font = '22px "Press Start 2P"';
                ctx.fillText("WSZYSTKIEGO", GAME_WIDTH / 2, GAME_HEIGHT / 2 - 20);
                ctx.fillText("NAJLEPSZEGO", GAME_WIDTH / 2, GAME_HEIGHT / 2 + 20);
            } else {
                ctx.font = '14px "Press Start 2P"';
                ctx.fillText("WSZYSTKIEGO NAJLEPSZEGO", GAME_WIDTH / 2, 60);
            }
            ctx.shadowColor = "transparent";

            if (winPhase === 1 || winPhase === 2) {
                ctx.fillStyle = 'rgba(0, 0, 0, 0.4)';
                ctx.fillRect(0, 0, GAME_WIDTH, GAME_HEIGHT);
                ctx.fillStyle = 'white';
                ctx.font = '16px "Press Start 2P"';
                ctx.shadowColor = "black";
                ctx.shadowOffsetX = 2; ctx.shadowOffsetY = 2;
                ctx.fillText("Wybierz Prezent:", GAME_WIDTH / 2, GAME_HEIGHT / 2 - 100);
                ctx.shadowColor = "transparent";
                const pSize = 80;
                const pY = GAME_HEIGHT / 2 - pSize / 2;
                const centersX = [GAME_WIDTH/2 - 110, GAME_WIDTH/2, GAME_WIDTH/2 + 110];
                for (let i = 0; i < 3; i++) {
                    let pX = centersX[i] - pSize / 2;
                    let currentY = pY;
                    if (winPhase === 2 && clickedPresentIndex === i) {
                        pX += Math.random() * 10 - 5;
                        currentY += Math.random() * 10 - 5;
                    }
                    if (presentImage.complete && presentImage.naturalWidth !== 0) ctx.drawImage(presentImage, pX, currentY, pSize, pSize);
                    else { ctx.fillStyle = 'blue'; ctx.fillRect(pX, currentY, pSize, pSize); }
                }
            }

            if (winPhase === 3) {
                ctx.fillStyle = 'rgba(0, 0, 0, 0.6)';
                ctx.fillRect(0, 0, GAME_WIDTH, GAME_HEIGHT);
                const brWidth = 300; const brHeight = 200;
                const brX = GAME_WIDTH / 2 - brWidth / 2;
                const brY = GAME_HEIGHT / 2 - brHeight / 2 - 30; 
                if (braceletImage.complete && braceletImage.naturalWidth !== 0) ctx.drawImage(braceletImage, brX, brY, brWidth, brHeight);
                else { ctx.fillStyle = 'pink'; ctx.fillRect(brX, brY, brWidth, brHeight); }

                if (Date.now() - revealTime >= 3000) {
                    const btnWidth = 300; const btnHeight = 60;
                    const btnX = GAME_WIDTH / 2 - btnWidth / 2; const btnY = GAME_HEIGHT - 120;
                    ctx.fillStyle = '#FFD700'; ctx.fillRect(btnX, btnY, btnWidth, btnHeight);
                    ctx.strokeStyle = '#FFFFFF'; ctx.lineWidth = 4; ctx.strokeRect(btnX, btnY, btnWidth, btnHeight);
                    ctx.fillStyle = '#000'; ctx.font = '12px "Press Start 2P"'; ctx.textAlign = 'center';
                    ctx.fillText("POKAZ INNE PREZENTY", GAME_WIDTH / 2, btnY + 36);
                }
            }

            if (winPhase === 4) {
                ctx.fillStyle = 'rgba(0, 0, 0, 0.8)';
                ctx.fillRect(0, 0, GAME_WIDTH, GAME_HEIGHT);
                ctx.fillStyle = 'white'; ctx.font = '14px "Press Start 2P"';
                ctx.shadowColor = "black"; ctx.shadowOffsetX = 2; ctx.shadowOffsetY = 2;
                ctx.fillText("W pozostalych byly:", GAME_WIDTH / 2, GAME_HEIGHT / 2 - 120);
                ctx.shadowColor = "transparent";

                const itemW = 110; const itemH = 60; 
                const pY = GAME_HEIGHT / 2 - itemH / 2;
                const centersX = [GAME_WIDTH/2 - 130, GAME_WIDTH/2, GAME_WIDTH/2 + 130];
                
                let trollPrizes = [teslaImage, domImage];
                let trollIndex = 0;

                for (let i = 0; i < 3; i++) {
                    let img;
                    if (i === clickedPresentIndex) {
                        img = braceletImage; 
                    } else {
                        img = trollPrizes[trollIndex]; 
                        trollIndex++;
                    }
                    
                    const itemX = centersX[i] - itemW / 2;
                    if (img.complete && img.naturalWidth !== 0) ctx.drawImage(img, itemX, pY, itemW, itemH);
                    else { ctx.fillStyle = 'gray'; ctx.fillRect(itemX, pY, itemW, itemH); }
                }

                 if (Date.now() - finalPhaseStartTime >= 3000) {
                    const btnWidth = 340; const btnHeight = 70;
                    const btnX = GAME_WIDTH / 2 - btnWidth / 2; const btnY = GAME_HEIGHT - 120;
                    
                    ctx.fillStyle = '#FF69B4'; 
                    ctx.fillRect(btnX, btnY, btnWidth, btnHeight);
                    ctx.strokeStyle = '#FFFFFF'; ctx.lineWidth = 4; ctx.strokeRect(btnX, btnY, btnWidth, btnHeight);
                    
                    ctx.fillStyle = '#FFF';
                    ctx.font = '11px "Press Start 2P"';
                    ctx.textAlign = 'center';
                    ctx.fillText("AKCEPTUJE PREZENT", GAME_WIDTH / 2, btnY + 30);
                    ctx.fillText("W IMIE MILOSCI", GAME_WIDTH / 2, btnY + 55);
                 }
            }
        }
    }

    function gameLoop() {
        update();
        draw();
        requestAnimationFrame(gameLoop);
    }

    initPlatforms();
    setTimeout(() => {
        gameLoop();
    }, 500);

</script>

</body>
</html>